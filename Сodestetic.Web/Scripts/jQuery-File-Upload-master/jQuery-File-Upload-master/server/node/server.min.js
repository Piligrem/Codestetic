!/usr/bin/env;node(function(n){"use strict";var r=require("path"),i=require("fs"),e=i.existsSync||r.existsSync,c=require("formidable"),o=require("node-static"),l=require("imagemagick"),t={tmpDir:__dirname+"/tmp",publicDir:__dirname+"/public",uploadDir:__dirname+"/public/files",uploadUrl:"/files/",maxPostSize:11e9,minFileSize:1,maxFileSize:1e10,acceptFileTypes:/.+/i,inlineFileTypes:/\.(gif|jpe?g|png)$/i,imageTypes:/\.(gif|jpe?g|png)$/i,imageVersions:{thumbnail:{width:80,height:80}},accessControl:{allowOrigin:"*",allowMethods:"OPTIONS, HEAD, GET, POST, PUT, DELETE",allowHeaders:"Content-Type, Content-Range, Content-Disposition"},nodeStatic:{cache:3600}},a=function(n){return unescape(encodeURIComponent(n))},s=new o.Server(t.publicDir,t.nodeStatic),v=/(?:(?: \(([\d]+)\))?(\.[^.]+))?$/,y=function(n,t,i){return" ("+((parseInt(t,10)||0)+1)+")"+(i||"")},u=function(n){this.name=n.name;this.size=n.size;this.type=n.type;this.deleteType="DELETE"},f=function(n,t,i){this.req=n;this.res=t;this.callback=i},h=function(n,i){i.setHeader("Access-Control-Allow-Origin",t.accessControl.allowOrigin);i.setHeader("Access-Control-Allow-Methods",t.accessControl.allowMethods);i.setHeader("Access-Control-Allow-Headers",t.accessControl.allowHeaders);var e=function(t,r){r?(i.writeHead(302,{Location:r.replace(/%s/,encodeURIComponent(JSON.stringify(t)))}),i.end()):(i.writeHead(200,{"Content-Type":n.headers.accept.indexOf("application/json")!==-1?"application/json":"text/plain"}),i.end(JSON.stringify(t)))},u=function(){i.setHeader("Pragma","no-cache");i.setHeader("Cache-Control","no-store, no-cache, must-revalidate");i.setHeader("Content-Disposition",'inline; filename="files.json"')},r=new f(n,i,e);switch(n.method){case"OPTIONS":i.end();break;case"HEAD":case"GET":n.url==="/"?(u(),n.method==="GET"?r.get():i.end()):s.serve(n,i);break;case"POST":u();r.post();break;case"DELETE":r.destroy();break;default:i.statusCode=405;i.end()}};s.respond=function(n,i,u,f,e,s,h,c){u["X-Content-Type-Options"]="nosniff";t.inlineFileTypes.test(f[0])||(u["Content-Type"]="application/octet-stream",u["Content-Disposition"]='attachment; filename="'+a(r.basename(f[0]))+'"');o.Server.prototype.respond.call(this,n,i,u,f,e,s,h,c)};u.prototype.validate=function(){return t.minFileSize&&t.minFileSize>this.size?this.error="File is too small":t.maxFileSize&&t.maxFileSize<this.size?this.error="File is too big":t.acceptFileTypes.test(this.name)||(this.error="Filetype not allowed"),!this.error};u.prototype.safeName=function(){for(this.name=r.basename(this.name).replace(/^\.+/,"");e(t.uploadDir+"/"+this.name);)this.name=this.name.replace(v,y)};u.prototype.initUrls=function(n){if(!this.error){var i=this,r=(t.ssl?"https:":"http:")+"//"+n.headers.host+t.uploadUrl;this.url=this.deleteUrl=r+encodeURIComponent(this.name);Object.keys(t.imageVersions).forEach(function(n){e(t.uploadDir+"/"+n+"/"+i.name)&&(i[n+"Url"]=r+n+"/"+encodeURIComponent(i.name))})}};f.prototype.get=function(){var n=this,r=[];i.readdir(t.uploadDir,function(f,e){e.forEach(function(f){var o=i.statSync(t.uploadDir+"/"+f),e;o.isFile()&&f[0]!=="."&&(e=new u({name:f,size:o.size}),e.initUrls(n.req),r.push(e))});n.callback({files:r})})};f.prototype.post=function(){var n=this,o=new c.IncomingForm,s=[],f=[],h={},e=1,a,v=function(){e-=1;e||(f.forEach(function(t){t.initUrls(n.req)}),n.callback({files:f},a))};o.uploadDir=t.tmpDir;o.on("fileBegin",function(n,t){s.push(t.path);var i=new u(t);i.safeName();h[r.basename(t.path)]=i;f.push(i)}).on("field",function(n,t){n==="redirect"&&(a=t)}).on("file",function(n,u){var f=h[r.basename(u.path)];if(f.size=u.size,!f.validate()){i.unlink(u.path);return}i.renameSync(u.path,t.uploadDir+"/"+f.name);t.imageTypes.test(f.name)&&Object.keys(t.imageVersions).forEach(function(n){e+=1;var i=t.imageVersions[n];l.resize({width:i.width,height:i.height,srcPath:t.uploadDir+"/"+f.name,dstPath:t.uploadDir+"/"+n+"/"+f.name},v)})}).on("aborted",function(){s.forEach(function(n){i.unlink(n)})}).on("error",function(n){console.log(n)}).on("progress",function(i){i>t.maxPostSize&&n.req.connection.destroy()}).on("end",v).parse(n.req)};f.prototype.destroy=function(){var n=this,u;if(n.req.url.slice(0,t.uploadUrl.length)===t.uploadUrl&&(u=r.basename(decodeURIComponent(n.req.url)),u[0]!==".")){i.unlink(t.uploadDir+"/"+u,function(r){Object.keys(t.imageVersions).forEach(function(n){i.unlink(t.uploadDir+"/"+n+"/"+u)});n.callback({success:!r})});return}n.callback({success:!1})};t.ssl?require("https").createServer(t.ssl,h).listen(n):require("http").createServer(h).listen(n)}(8888));
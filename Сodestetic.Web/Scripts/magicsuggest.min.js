(function(n){"use strict";var t=function(t,i){var r=this,y={allowFreeEntries:!0,cls:"",data:null,dataUrlParams:{},disabled:!1,displayField:"name",editable:!0,expanded:!1,expandOnFocus:!1,groupBy:null,hideTrigger:!1,highlight:!0,id:null,infoMsgCls:"",inputCfg:{},invalidCls:"ms-inv",matchCase:!1,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(n){return"Please reduce your entry by "+n+" character"+(n>1?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(n){return"You cannot choose more than "+n+" item"+(n>1?"s":"")},method:"POST",minChars:0,minCharsRenderer:function(n){return"Please type "+n+" more character"+(n>1?"s":"")},mode:"local",name:null,noSuggestionText:"No suggestions",placeholder:"Type or click here",autoSelect:!0,renderer:null,required:!1,resultAsString:!1,resultsField:"results",selectionCls:"",selectionPosition:"inner",selectionRenderer:null,selectionStacked:!1,sortDir:"asc",sortOrder:null,strictSuggest:!1,style:"",toggleOnClick:!1,typeDelay:400,useTabKey:!1,useCommaKey:!0,useZebraStyle:!1,value:null,valueField:"id"},p=n.extend({},i),u=n.extend(!0,{},y,p);this.addToSelection=function(t,i){if(!u.maxSelection||e.length<u.maxSelection){n.isArray(t)||(t=[t]);var o=!1;n.each(t,function(t,i){n.inArray(i[u.valueField],r.getValue())===-1&&(e.push(i),o=!0)});o===!0&&(f._renderSelection(),this.empty(),i!==!0&&n(this).trigger("selectionchange",[this,this.getSelection()]))}this.input.attr("placeholder",u.selectionPosition==="inner"&&this.getValue().length>0?"":u.placeholder)};this.clear=function(n){this.removeFromSelection(e.slice(0),n)};this.collapse=function(){u.expanded===!0&&(this.combobox.detach(),u.expanded=!1,n(this).trigger("collapse",[this]))};this.disable=function(){this.container.addClass("ms-ctn-disabled");u.disabled=!0;r.input.attr("disabled",!0)};this.empty=function(){this.input.val("")};this.enable=function(){this.container.removeClass("ms-ctn-disabled");u.disabled=!1;r.input.attr("disabled",!1)};this.expand=function(){!u.expanded&&(this.input.val().length>=u.minChars||this.combobox.children().size()>0)&&(this.combobox.appendTo(this.container),f._processSuggestions(),u.expanded=!0,n(this).trigger("expand",[this]))};this.isDisabled=function(){return u.disabled};this.isValid=function(){return u.required===!1||e.length>0};this.getDataUrlParams=function(){return u.dataUrlParams};this.getName=function(){return u.name};this.getSelection=function(){return e};this.getRawValue=function(){return r.input.val()};this.getValue=function(){return n.map(e,function(n){return n[u.valueField]})};this.removeFromSelection=function(t,i){n.isArray(t)||(t=[t]);var o=!1;n.each(t,function(t,i){var f=n.inArray(i[u.valueField],r.getValue());f>-1&&(e.splice(f,1),o=!0)});o===!0&&(f._renderSelection(),i!==!0&&n(this).trigger("selectionchange",[this,this.getSelection()]),u.expandOnFocus&&r.expand(),u.expanded&&f._processSuggestions());this.input.attr("placeholder",u.selectionPosition==="inner"&&this.getValue().length>0?"":u.placeholder)};this.getData=function(){return u.data};this.setData=function(n){u.data=n;f._processSuggestions()};this.setName=function(t){u.name=t;t&&(u.name+=t.indexOf("[]")>0?"":"[]");r._valueContainer&&n.each(r._valueContainer.children(),function(n,t){t.name=u.name})};this.setSelection=function(n){this.clear();this.addToSelection(n)};this.setValue=function(t){var i=[];n.each(t,function(t,r){var e=!1,f;n.each(l,function(n,t){if(t[u.valueField]==r)return i.push(t),e=!0,!1});e||(typeof r=="object"?i.push(r):(f={},f[u.valueField]=r,f[u.displayField]=r,i.push(f)))});i.length>0&&this.addToSelection(i)};this.setDataUrlParams=function(t){u.dataUrlParams=n.extend({},t)};var e=[],c=0,v,s=!1,h=null,l=[],a=!1,f={_displaySuggestions:function(t){var i,e,o;if(r.combobox.show(),r.combobox.empty(),i=0,e=0,h===null)f._renderComboItems(t),i=c*t.length;else{for(o in h)e+=1,n("<div/>",{"class":"ms-res-group",html:o}).appendTo(r.combobox),f._renderComboItems(h[o].items,!0);i=c*(t.length+e)}i<r.combobox.height()||i<=u.maxDropHeight?r.combobox.height(i):i>=r.combobox.height()&&i>u.maxDropHeight&&r.combobox.height(u.maxDropHeight);t.length===1&&u.autoSelect===!0&&r.combobox.children().filter(":last").addClass("ms-res-item-active");t.length===0&&r.getRawValue()!==""&&(f._updateHelper(u.noSuggestionText),r.collapse());t.length===0&&r.combobox.hide()},_getEntriesFromStringArray:function(t){var i=[];return n.each(t,function(t,r){var f={};f[u.displayField]=f[u.valueField]=n.trim(r);i.push(f)}),i},_highlightSuggestion:function(n){var t=r.input.val();return t.length===0?n:u.matchCase===!0?n.replace(new RegExp("("+t+")(?!([^<]+)?>)","g"),"<em>$1<\/em>"):n.replace(new RegExp("("+t+")(?!([^<]+)?>)","gi"),"<em>$1<\/em>")},_moveSelectedRow:function(n){u.expanded||r.expand();var i,t,f,e;i=r.combobox.find(".ms-res-item");t=n==="down"?i.eq(0):i.filter(":last");f=r.combobox.find(".ms-res-item-active:first");f.length>0&&(n==="down"?(t=f.nextAll(".ms-res-item").first(),t.length===0&&(t=i.eq(0)),e=r.combobox.scrollTop(),r.combobox.scrollTop(0),t[0].offsetTop+t.outerHeight()>r.combobox.height()&&r.combobox.scrollTop(e+c)):(t=f.prevAll(".ms-res-item").first(),t.length===0&&(t=i.filter(":last"),r.combobox.scrollTop(c*i.length)),t[0].offsetTop<r.combobox.scrollTop()&&r.combobox.scrollTop(r.combobox.scrollTop()-c)));i.removeClass("ms-res-item-active");t.addClass("ms-res-item-active")},_processSuggestions:function(t){var e=null,i=t||u.data,o,s;if(i!==null){if(typeof i=="function"&&(i=i.call(r)),typeof i=="string"){n(r).trigger("beforeload",[r]);o=n.extend({query:r.input.val()},u.dataUrlParams);n.ajax({type:u.method,url:i,data:o,success:function(t){e=typeof t=="string"?JSON.parse(t):t;f._processSuggestions(e);n(r).trigger("load",[r,e]);f._asyncValues&&(r.setValue(typeof f._asyncValues=="string"?JSON.parse(f._asyncValues):f._asyncValues),f._renderSelection(),delete f._asyncValues)},error:function(){throw"Could not reach server";}});return}l=i.length>0&&typeof i[0]=="string"?f._getEntriesFromStringArray(i):i[u.resultsField]||i;s=u.mode==="remote"?l:f._sortAndTrim(l);f._displaySuggestions(f._group(s))}},_render:function(t){r.setName(u.name);r.container=n("<div/>",{"class":"ms-ctn form-control "+(u.resultAsString?"ms-as-string ":"")+u.cls+(u.disabled===!0?" ms-ctn-disabled":"")+(u.editable===!0?"":" ms-ctn-readonly")+(u.hideTrigger===!1?"":" ms-no-trigger"),style:u.style});r.container.focus(n.proxy(o._onFocus,this));r.container.blur(n.proxy(o._onBlur,this));r.container.keydown(n.proxy(o._onKeyDown,this));r.container.keyup(n.proxy(o._onKeyUp,this));r.input=n("<input/>",n.extend({type:"text","class":u.editable===!0?"":" ms-input-readonly",readonly:!u.editable,placeholder:u.placeholder,disabled:u.disabled},u.inputCfg));r.input.focus(n.proxy(o._onInputFocus,this));r.input.click(n.proxy(o._onInputClick,this));r.combobox=n("<div/>",{"class":"ms-res-ctn dropdown-menu"}).height(u.maxDropHeight);r.combobox.on("click","div.ms-res-item",n.proxy(o._onComboItemSelected,this));r.combobox.on("mouseover","div.ms-res-item",n.proxy(o._onComboItemMouseOver,this));r.selectionContainer=n("<div/>",{"class":"ms-sel-ctn"});r.selectionContainer.click(n.proxy(o._onFocus,this));u.selectionPosition==="inner"?r.selectionContainer.append(r.input):r.container.append(r.input);r.helper=n("<span/>",{"class":"ms-helper "+u.infoMsgCls});f._updateHelper();r.container.append(r.helper);n(t).replaceWith(r.container);switch(u.selectionPosition){case"bottom":r.selectionContainer.insertAfter(r.container);u.selectionStacked===!0&&(r.selectionContainer.width(r.container.width()),r.selectionContainer.addClass("ms-stacked"));break;case"right":r.selectionContainer.insertAfter(r.container);r.container.css("float","left");break;default:r.container.append(r.selectionContainer)}u.hideTrigger===!1&&(r.trigger=n("<div/>",{"class":"ms-trigger",html:'<div class="ms-trigger-ico"><\/div>'}),r.trigger.click(n.proxy(o._onTriggerClick,this)),r.container.append(r.trigger));u.value!==null&&(typeof u.data=="string"?(f._asyncValues=u.value,f._processSuggestions()):(f._processSuggestions(),r.setValue(u.value),f._renderSelection()));n("body").click(function(n){r.container.hasClass("ms-ctn-focus")&&r.container.has(n.target).length===0&&n.target.className.indexOf("ms-res-item")<0&&n.target.className.indexOf("ms-close-btn")<0&&r.container[0]!==n.target&&o._onBlur()});u.expanded===!0&&(u.expanded=!1,r.expand())},_renderComboItems:function(t,i){var e=this,s="";n.each(t,function(t,r){var c=u.renderer!==null?u.renderer.call(e,r):r[u.displayField],h=n("<div/>",{"class":"ms-res-item "+(i?"ms-res-item-grouped ":"")+(t%2==1&&u.useZebraStyle===!0?"ms-res-odd":""),html:u.highlight===!0?f._highlightSuggestion(c):c,"data-json":JSON.stringify(r)});h.click(n.proxy(o._onComboItemSelected,e));h.mouseover(n.proxy(o._onComboItemMouseOver,e));s+=n("<div/>").append(h).html()});r.combobox.append(s);c=r.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var t=this,i=0,h=0,c=[],l=u.resultAsString===!0&&!s;r.selectionContainer.find(".ms-sel-item").remove();r._valueContainer!==undefined&&r._valueContainer.remove();n.each(e,function(i,r){var f,s,h=u.selectionRenderer!==null?u.selectionRenderer.call(t,r):r[u.displayField];l===!0?f=n("<div/>",{"class":"ms-sel-item ms-sel-text "+u.selectionCls,html:h+(i===e.length-1?"":",")}).data("json",r):(f=n("<div/>",{"class":"ms-sel-item "+u.selectionCls,html:h}).data("json",r),u.disabled===!1&&(s=n("<span/>",{"class":"ms-close-btn"}).data("json",r).appendTo(f),s.click(n.proxy(o._onTagTriggerClick,t))));c.push(f)});r.selectionContainer.prepend(c);r._valueContainer=n("<div/>",{style:"display: none;"});n.each(r.getValue(),function(t,i){var f=n("<input/>",{type:"hidden",name:u.name,value:i});f.appendTo(r._valueContainer)});r._valueContainer.appendTo(r.selectionContainer);u.selectionPosition==="inner"&&(r.input.width(0),h=r.input.offset().left-r.selectionContainer.offset().left,i=r.container.width()-h-42,r.input.width(i));e.length===u.maxSelection?f._updateHelper(u.maxSelectionRenderer.call(this,e.length)):r.helper.hide()},_selectItem:function(n){u.maxSelection===1&&(e=[]);r.addToSelection(n.data("json"));n.removeClass("ms-res-item-active");(u.expandOnFocus===!1||e.length===u.maxSelection)&&r.collapse();s?s&&(u.expandOnFocus||a)&&(f._processSuggestions(),a&&r.expand()):r.input.focus()},_sortAndTrim:function(t){var f=r.getRawValue(),e=[],i=[],o=r.getValue();return f.length>0?n.each(t,function(n,t){var i=t[u.displayField];(u.matchCase===!0&&i.indexOf(f)>-1||u.matchCase===!1&&i.toLowerCase().indexOf(f.toLowerCase())>-1)&&(u.strictSuggest===!1||i.toLowerCase().indexOf(f.toLowerCase())===0)&&e.push(t)}):e=t,n.each(e,function(t,r){n.inArray(r[u.valueField],o)===-1&&i.push(r)}),u.sortOrder!==null&&i.sort(function(n,t){return n[u.sortOrder]<t[u.sortOrder]?u.sortDir==="asc"?-1:1:n[u.sortOrder]>t[u.sortOrder]?u.sortDir==="asc"?1:-1:0}),u.maxSuggestions&&u.maxSuggestions>0&&(i=i.slice(0,u.maxSuggestions)),i},_group:function(t){return u.groupBy!==null&&(h={},n.each(t,function(n,t){h[t[u.groupBy]]===undefined?h[t[u.groupBy]]={title:t[u.groupBy],items:[t]}:h[t[u.groupBy]].items.push(t)})),t},_updateHelper:function(n){r.helper.html(n);r.helper.is(":visible")||r.helper.fadeIn()}},o={_onBlur:function(){if(r.container.removeClass("ms-ctn-focus"),r.collapse(),s=!1,r.getRawValue()!==""&&u.allowFreeEntries===!0){var t={};t[u.displayField]=t[u.valueField]=r.getRawValue().trim();r.addToSelection(t)}f._renderSelection();r.isValid()===!1?r.container.addClass(u.invalidCls):r.input.val()!==""&&u.allowFreeEntries===!1&&(r.empty(),f._updateHelper(""));n(r).trigger("blur",[r])},_onComboItemMouseOver:function(t){r.combobox.children().removeClass("ms-res-item-active");n(t.currentTarget).addClass("ms-res-item-active")},_onComboItemSelected:function(t){f._selectItem(n(t.currentTarget))},_onFocus:function(){r.input.focus()},_onInputClick:function(){r.isDisabled()===!1&&s&&u.toggleOnClick===!0&&(u.expanded?r.collapse():r.expand())},_onInputFocus:function(){if(r.isDisabled()===!1&&!s){s=!0;r.container.addClass("ms-ctn-focus");r.container.removeClass(u.invalidCls);var t=r.getRawValue().length;u.expandOnFocus===!0&&r.expand();e.length===u.maxSelection?f._updateHelper(u.maxSelectionRenderer.call(this,e.length)):t<u.minChars&&f._updateHelper(u.minCharsRenderer.call(this,u.minChars-t));f._renderSelection();n(r).trigger("focus",[r])}},_onKeyDown:function(t){var i=r.combobox.find(".ms-res-item-active:first"),s=r.input.val();if(n(r).trigger("keydown",[r,t]),t.keyCode===9&&(u.useTabKey===!1||u.useTabKey===!0&&i.length===0&&r.input.val().length===0)){o._onBlur();return}switch(t.keyCode){case 8:s.length===0&&r.getSelection().length>0&&u.selectionPosition==="inner"&&(e.pop(),f._renderSelection(),n(r).trigger("selectionchange",[r,r.getSelection()]),r.input.attr("placeholder",u.selectionPosition==="inner"&&this.getValue().length>0?"":u.placeholder),r.input.focus(),t.preventDefault());break;case 9:case 188:case 13:t.preventDefault();break;case 17:a=!0;break;case 40:t.preventDefault();f._moveSelectedRow("down");break;case 38:t.preventDefault();f._moveSelectedRow("up");break;default:e.length===u.maxSelection&&t.preventDefault()}},_onKeyUp:function(t){var i=r.getRawValue(),h=n.trim(r.input.val()).length>0&&(!u.maxEntryLength||n.trim(r.input.val()).length<=u.maxEntryLength),o,s={};if(n(r).trigger("keyup",[r,t]),clearTimeout(v),t.keyCode===27&&u.expanded&&r.combobox.hide(),t.keyCode===9&&u.useTabKey===!1||t.keyCode>13&&t.keyCode<32){t.keyCode===17&&(a=!1);return}switch(t.keyCode){case 40:case 38:t.preventDefault();break;case 13:case 9:case 188:if(t.keyCode!==188||u.useCommaKey===!0){if(t.preventDefault(),u.expanded===!0&&(o=r.combobox.find(".ms-res-item-active:first"),o.length>0)){f._selectItem(o);return}h===!0&&u.allowFreeEntries===!0&&(s[u.displayField]=s[u.valueField]=i.trim(),r.addToSelection(s),r.collapse(),r.input.focus());break}default:e.length===u.maxSelection?f._updateHelper(u.maxSelectionRenderer.call(this,e.length)):i.length<u.minChars?(f._updateHelper(u.minCharsRenderer.call(this,u.minChars-i.length)),u.expanded===!0&&r.collapse()):u.maxEntryLength&&i.length>u.maxEntryLength?(f._updateHelper(u.maxEntryRenderer.call(this,i.length-u.maxEntryLength)),u.expanded===!0&&r.collapse()):(r.helper.hide(),u.minChars<=i.length&&(v=setTimeout(function(){u.expanded===!0?f._processSuggestions():r.expand()},u.typeDelay)))}},_onTagTriggerClick:function(t){r.removeFromSelection(n(t.currentTarget).data("json"))},_onTriggerClick:function(){if(r.isDisabled()===!1&&!(u.expandOnFocus===!0&&e.length===u.maxSelection))if(n(r).trigger("triggerclick",[r]),u.expanded===!0)r.collapse();else{var t=r.getRawValue().length;t>=u.minChars?(r.input.focus(),r.expand()):f._updateHelper(u.minCharsRenderer.call(this,u.minChars-t))}}};t!==null&&f._render(t)};n.fn.magicSuggest=function(i){var r=n(this);return r.size()===1&&r.data("magicSuggest")?r.data("magicSuggest"):(r.each(function(){var f=n(this),u,r;f.data("magicSuggest")||(this.nodeName.toLowerCase()==="select"&&(i.data=[],i.value=[],n.each(this.children,function(n,t){t.nodeName&&t.nodeName.toLowerCase()==="option"&&(i.data.push({id:t.value,name:t.text}),t.selected&&i.value.push(t.value))})),u={},n.each(this.attributes,function(n,t){u[t.name]=t.value}),r=new t(this,n.extend([],n.fn.magicSuggest.defaults,i,u)),f.data("magicSuggest",r),r.container.data("magicSuggest",r))}),r.size()===1)?r.data("magicSuggest"):r};n.fn.magicSuggest.defaults={}})(jQuery);